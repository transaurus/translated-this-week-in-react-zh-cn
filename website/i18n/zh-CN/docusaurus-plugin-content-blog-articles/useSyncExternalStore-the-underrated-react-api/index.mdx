---
slug: useSyncExternalStore-the-underrated-react-api
title: useSyncExternalStore - The underrated React API
authors: [slorber]
date: 2022-09-06
twitterThreadUrl: "https://slo.im/t/articles/useSyncExternalStore"
image: ./social-card.png
---

# useSyncExternalStore - è¢«ä½ä¼°çš„React API

ä½ å¯èƒ½å¬è¯´è¿‡[`useSyncExternalStore()`](https://reactjs.org/docs/hooks-reference.html#usesyncexternalstore)ï¼Œè¿™ä¸ªReact 18çš„æ–°Hookç”¨äº**è®¢é˜…å¤–éƒ¨æ•°æ®æº**ã€‚å®ƒå¸¸è¢«çŠ¶æ€ç®¡ç†åº“ï¼ˆå¦‚[Redux](https://github.com/reduxjs/react-redux/pull/1808)ï¼‰å†…éƒ¨ä½¿ç”¨ï¼Œç”¨äºå®ç°**é€‰æ‹©å™¨ç³»ç»Ÿ**ã€‚

ä½†ä½ æ˜¯å¦è€ƒè™‘è¿‡åœ¨è‡ªå·±çš„åº”ç”¨ä»£ç ä¸­ä½¿ç”¨`useSyncExternalStore()`ï¼Ÿ

åœ¨è¿™ç¯‡äº’åŠ¨æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³æå‡ºä¸€ä¸ªé—®é¢˜ï¼š**è¿‡åº¦è¿”å›å€¼çš„React Hookä¼šè§¦å‘ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“**ã€‚æˆ‘ä»¬å°†çœ‹åˆ°`useSyncExternalStore()`å¦‚ä½•æˆä¸ºè§£å†³æ–¹æ¡ˆã€‚

![ç¤¾äº¤å¡ç‰‡](./social-card.png)

<!-- truncate -->

<SubscribeFormEmbed />

import {
  App,
  AppFixed,
  ScrollApp,
} from "@site/articles/useSyncExternalStore-the-underrated-react-api/demos";

## è¿‡åº¦è¿”å›çš„Hook

è®©æˆ‘ä»¬ç”¨React-Routerçš„[`useLocation()`](https://reactrouter.com/en/main/hooks/use-location)æ¥è¯´æ˜è¿™ä¸ªé—®é¢˜ã€‚

è¯¥Hookè¿”å›åŒ…å«å¤šä¸ªå±æ€§ï¼ˆ`pathname`ã€`hash`ã€`search`ç­‰ï¼‰çš„å¯¹è±¡ï¼Œä½†ä½ å¯èƒ½ä¸ä¼šä½¿ç”¨å…¨éƒ¨å±æ€§ã€‚ä»…è°ƒç”¨è¯¥Hookå°±ä¼šåœ¨ä»»æ„å±æ€§æ›´æ–°æ—¶è§¦å‘é‡æ–°æ¸²æŸ“ã€‚

è€ƒè™‘ä»¥ä¸‹åº”ç”¨ï¼š

```tsx
function CurrentPathname() {
  const { pathname } = useLocation();
  return <div>{pathname}</div>;
}

function CurrentHash() {
  const { hash } = useLocation();
  return <div>{hash}</div>;
}

function Links() {
  return (
    <div>
      <Link to="#link1">#link1</Link>
      <Link to="#link2">#link2</Link>
      <Link to="#link3">#link3</Link>
    </div>
  );
}

function App() {
  return (
    <div>
      <CurrentPathname />
      <CurrentHash />
      <Links />
    </div>
  );
}
```

<App />

æ¯æ¬¡ç‚¹å‡»å“ˆå¸Œé“¾æ¥æ—¶ï¼Œ`CurrentPathname`ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“â€”â€”å³ä½¿å®ƒæ ¹æœ¬æ²¡æœ‰ä½¿ç”¨`hash`å±æ€§ ğŸ˜…ã€‚

:::tip

å½“Hookè¿”å›çš„æ•°æ®æœªè¢«ä½¿ç”¨æ—¶ï¼Œè¯·è€ƒè™‘Reactçš„é‡æ–°æ¸²æŸ“æœºåˆ¶ã€‚å¦‚æœä¸åŠ æ³¨æ„ï¼Œåœ¨Reactæ ‘é¡¶éƒ¨æ·»åŠ çš„ä¸€ä¸ªå°å°`useLocation()`è°ƒç”¨å°±å¯èƒ½æŸå®³åº”ç”¨æ€§èƒ½ã€‚

:::

:::info

æœ¬æ–‡å¹¶éæ‰¹è¯„React-Routerï¼Œè€Œæ˜¯ä¸ºäº†è¯´æ˜é—®é¢˜ã€‚`useLocation()`åªæ˜¯æ„å»ºè¿™ç¯‡äº’åŠ¨æ–‡ç« çš„å…¸å‹æ¡ˆä¾‹ã€‚ä½ è‡ªå·±çš„React Hookæˆ–å…¶ä»–ç¬¬ä¸‰æ–¹åº“ä¹Ÿå¯èƒ½å­˜åœ¨è¿‡åº¦è¿”å›å€¼çš„æƒ…å†µã€‚

:::

## `useSyncExternalStore`æ¥æ•‘æ´ï¼Ÿ

[å®˜æ–¹æ–‡æ¡£](https://reactjs.org/docs/hooks-reference.html#usesyncexternalstore)è¯´æ˜ï¼š

> useSyncExternalStoreæ˜¯ä¸€ä¸ªæ¨èç”¨äºè¯»å–å’Œè®¢é˜…å¤–éƒ¨æ•°æ®æºçš„Hookï¼Œå…¶å®ç°æ–¹å¼ä¸é€‰æ‹©æ€§æ³¨æ°´å’Œæ—¶é—´åˆ‡ç‰‡ç­‰å¹¶å‘æ¸²æŸ“ç‰¹æ€§å…¼å®¹ã€‚
> è¯¥æ–¹æ³•è¿”å›å­˜å‚¨çš„å€¼å¹¶æ¥å—ä¸‰ä¸ªå‚æ•°ï¼š
>
> - `subscribe`: ç”¨äºæ³¨å†Œåœ¨å­˜å‚¨å˜åŒ–æ—¶è¢«è°ƒç”¨çš„å›è°ƒå‡½æ•°
> - `getSnapshot`: è¿”å›å­˜å‚¨å½“å‰å€¼çš„å‡½æ•°
> - `getServerSnapshot`: æœåŠ¡ç«¯æ¸²æŸ“æ—¶è¿”å›å¿«ç…§çš„å‡½æ•°

```tsx
function useSyncExternalStore<Snapshot>(
  subscribe: (onStoreChange: () => void) => () => void,
  getSnapshot: () => Snapshot,
  getServerSnapshot?: () => Snapshot,
): Snapshot;
```

è¿™å¬èµ·æ¥æœ‰äº›æŠ½è±¡ã€‚[Betaç‰ˆæ–‡æ¡£](https://beta.reactjs.org/learn/you-might-not-need-an-effect#subscribing-to-an-external-store)æä¾›äº†å¾ˆå¥½çš„ç¤ºä¾‹ï¼š

```tsx
function subscribe(callback) {
  window.addEventListener("online", callback);
  window.addEventListener("offline", callback);
  return () => {
    window.removeEventListener("online", callback);
    window.removeEventListener("offline", callback);
  };
}

function useOnlineStatus() {
  return useSyncExternalStore(
    subscribe,
    () => navigator.onLine,
    () => true,
  );
}

function ChatIndicator() {
  const isOnline = useOnlineStatus();
  // ...
}
```

å®é™…ä¸Šï¼Œæµè§ˆå™¨å†å²è®°å½•ä¹Ÿå¯ä»¥è¢«è§†ä¸ºå¤–éƒ¨æ•°æ®æºã€‚è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å°†`useSyncExternalStore`ä¸React-Routerç»“åˆä½¿ç”¨ï¼

## å®ç°`useHistorySelector()`

React-Routeræä¾›äº†æˆ‘ä»¬è¿æ¥`useSyncExternalStore`æ‰€éœ€çš„ä¸€åˆ‡ï¼š

- é€šè¿‡[`useHistory()`](https://v5.reactrouter.com/web/api/Hooks/usehistory)è®¿é—®æµè§ˆå™¨å†å²è®°å½•
- é€šè¿‡[`history.listen(callback)`](https://github.com/remix-run/history/blob/main/docs/api-reference.md#history.listen)è®¢é˜…å†å²è®°å½•æ›´æ–°
- é€šè¿‡[`history.location`](https://github.com/remix-run/history/blob/main/docs/api-reference.md#historylocation)è®¿é—®å½“å‰ä½ç½®å¿«ç…§

:::caution

æœ¬ç½‘ç«™ä½¿ç”¨React-Router v5ï¼šReact-Router v6çš„è§£å†³æ–¹æ¡ˆä¼šæœ‰æ‰€ä¸åŒï¼ˆ[å‚è§](https://twitter.com/Zh0uzi/status/1567523679604539405)ï¼‰ã€‚

:::

`useHistorySelector()` çš„å®ç°ç›¸å¯¹ç®€å•ï¼š

```tsx
function useHistorySelector(selector) {
  const history = useHistory();
  return useSyncExternalStore(history.listen, () =>
    selector(history),
  );
}
```

è®©æˆ‘ä»¬åœ¨åº”ç”¨ä¸­ä½¿ç”¨å®ƒï¼š

```tsx
function CurrentPathname() {
  const pathname = useHistorySelector(
    (history) => history.location.pathname,
  );
  return <div>{pathname}</div>;
}

function CurrentHash() {
  const hash = useHistorySelector(
    (history) => history.location.hash,
  );
  return <div>{hash}</div>;
}
```

<AppFixed />

ç°åœ¨ï¼Œå½“ä½ ç‚¹å‡»ä¸Šé¢çš„å“ˆå¸Œé“¾æ¥æ—¶ï¼Œ`CurrentPathname` ç»„ä»¶å°†**ä¸å†é‡æ–°æ¸²æŸ“**ï¼

## å¦ä¸€ä¸ªç¤ºä¾‹ï¼š`scrollY`

æˆ‘ä»¬å¯ä»¥è®¢é˜…çš„å¤–éƒ¨æ•°æ®æºéå¸¸å¤šï¼Œåœ¨å…¶åŸºç¡€ä¸Šå®ç°è‡ªå·±çš„é€‰æ‹©å™¨ç³»ç»Ÿå¯èƒ½æœ‰åŠ©äºä¼˜åŒ– React çš„é‡æ–°æ¸²æŸ“ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æƒ³ä½¿ç”¨é¡µé¢çš„ `scrollY` ä½ç½®ã€‚æˆ‘ä»¬å¯ä»¥å®ç°è¿™ä¸ªè‡ªå®šä¹‰ React Hookï¼š

```tsx
// A memoized constant fn prevents unsubscribe/resubscribe
// In practice it is not a big deal
function subscribe(onStoreChange) {
  global.window?.addEventListener("scroll", onStoreChange);
  return () =>
    global.window?.removeEventListener(
      "scroll",
      onStoreChange,
    );
}

function useScrollY(selector = (id) => id) {
  return useSyncExternalStore(
    subscribe,
    () => selector(global.window?.scrollY),
    () => undefined,
  );
}
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ª Hook å¹¶ä¼ å…¥ä¸€ä¸ªå¯é€‰çš„é€‰æ‹©å™¨ï¼š

```tsx
function ScrollY() {
  const scrollY = useScrollY();
  return <div>{scrollY}</div>;
}

function ScrollYFloored() {
  const to = 100;
  const scrollYFloored = useScrollY((y) =>
    y ? Math.floor(y / to) * to : undefined,
  );
  return <div>{scrollYFloored}</div>;
}
```

<ScrollApp />

æ»šåŠ¨é¡µé¢å¹¶è§‚å¯Ÿä¸Šæ–¹ç»„ä»¶çš„é‡æ–°æ¸²æŸ“æƒ…å†µï¼Ÿå…¶ä¸­ä¸€ä¸ªç»„ä»¶çš„é‡æ–°æ¸²æŸ“æ¬¡æ•°æ¯”å¦ä¸€ä¸ªå°‘ï¼

:::info

å½“ä½ ä¸éœ€è¦ `scrollY` çš„ 1 åƒç´ ç²¾åº¦æ—¶ï¼Œè¿”å›ä¸€ä¸ªå®½æ³›çš„å€¼ï¼ˆå¦‚ `scrollY`ï¼‰ä¹Ÿå¯ä»¥è¢«è§†ä¸ºè¿‡åº¦è¿”å›ã€‚è€ƒè™‘è¿”å›ä¸€ä¸ªæ›´çª„çš„å€¼ã€‚

ä¾‹å¦‚ï¼šä¸€ä¸ªä»…è¿”å›æœ‰é™å€¼é›†ï¼ˆ`small`ã€`medium` æˆ– `large`ï¼‰çš„ `useResponsiveBreakpoint()` Hook ä¼šæ¯”è¿”å› `useViewportWidth()` çš„ Hook æ›´ä¼˜åŒ–ã€‚

å¦‚æœä¸€ä¸ª React ç»„ä»¶ä»…é’ˆå¯¹ `large` å±å¹•æœ‰ä¸åŒå¤„ç†ï¼Œä½ ç”šè‡³å¯ä»¥åˆ›å»ºä¸€ä¸ªæ›´çª„çš„ `useIsLargeScreen()` Hookï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚

:::

## ç»“è®º

æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½è®©ä½ é‡æ–°å®¡è§† `useSyncExternalStore()`ã€‚æˆ‘è§‰å¾—è¿™ä¸ª Hook ç›®å‰åœ¨ React ç”Ÿæ€ç³»ç»Ÿä¸­ä½¿ç”¨ä¸è¶³ï¼Œå€¼å¾—æ›´å¤šå…³æ³¨ã€‚æœ‰è®¸å¤šå¤–éƒ¨æ•°æ®æºå¯ä»¥è®¢é˜…ã€‚

å¦‚æœä½ è¿˜æ²¡æœ‰å‡çº§åˆ° React 18ï¼Œå¯ä»¥ä½¿ç”¨ npm ä¸Šçš„ [use-sync-external-store](https://www.npmjs.com/package/use-sync-external-store) å«ç‰‡ï¼Œå®ƒå·²ç»æ”¯æŒæ—§ç‰ˆæœ¬ã€‚å¦‚æœä½ éœ€è¦è¿”å›ä¸€ä¸ªè®°å¿†åŒ–çš„éåŸå§‹å€¼ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ `use-sync-external-store/with-selector` å¯¼å‡ºã€‚